---
title: "scRNA-glioma-workflows: van Hijfte dataset - Sample Y"
author: 
  - Youri Hoogstrate
  - Levi van Hijfte
  - Santoesha A. Ghisai
date: "`r BiocStyle::doc_date()`"
---

# Load libraries and functions

```{r}
library(ggplot2)

#source('R/function__remove_doublets.R')
source('R/function__annotate_read_fractions.R')


source('R/load__celltype_markers.R')
```


# Import data & set config

```{r}

config <- list(
  sample_name = 'van Hijfte dataset - Sample Y',
  path = "data/van_Hijfte__Sample_Y/filtered_feature_bc_matrix",
  
  random.seed = 1,
  
  seurat.min.cells = 3,
  seurat.min.features = 200,
  
  seurat.vst.nfeatures = 2000,
  
  min.nFeature_RNA = 750,
  min.nCount_RNA = 1400,
  
  pca.informative.components = 34
)


obj__van_hijfte__sample_y <- Seurat::Read10X(data.dir = config$path) |> 
  Seurat::CreateSeuratObject(min.cells = config$seurat.min.cells,
                             min.features = config$seurat.min.features,
                             project = config$sample_name)

obj__van_hijfte__sample_y@misc <- config


rm(config)

set.seed(obj__van_hijfte__sample_y@misc$random.seed)
stopifnot(.Random.seed[1] == 10403) # I guess this is some universal thing?
```

# Annotate fractions rRNA and MT-RNA

```{r}
obj__van_hijfte__sample_y <- annotate_read_fractions(obj__van_hijfte__sample_y) # percentage MT, Ribo RNA and MALAT1
```

# Q/C
## Exclude low-res cells

```{r}
Seurat::VlnPlot(object = obj__van_hijfte__sample_y, features = c("percentage_ribosomal_reads", "percentage_MALAT1_reads"), ncol = 3, pt.size = 0.01, group.by = "orig.ident")

Seurat::VlnPlot(object = obj__van_hijfte__sample_y, features = c("nFeature_RNA", "nCount_RNA","percentage_mitochondrial_reads"), ncol = 2, pt.size = 0.01, group.by = "orig.ident")
```


```{r}
ggplot(obj__van_hijfte__sample_y@meta.data, aes(y=`nFeature_RNA`, x=orig.ident)) +
  geom_jitter(cex=0.01) +
  geom_hline(yintercept = obj__van_hijfte__sample_y@misc$min.nFeature_RNA, col="red") +
  geom_hline(yintercept = 4500,col="red")

ggplot(obj__van_hijfte__sample_y@meta.data, aes(y=`nCount_RNA`, x=orig.ident)) +
  geom_jitter(cex=0.01)  +
  geom_hline(yintercept = obj__van_hijfte__sample_y@misc$min.nCount_RNA, col="red") +
  geom_hline(yintercept = 14000,col="red")
  #scale_y_log10()

obj__van_hijfte__sample_y <- subset(x = obj__van_hijfte__sample_y, subset = 
                     nFeature_RNA >= obj__van_hijfte__sample_y@misc$min.nFeature_RNA &
                     nCount_RNA >= obj__van_hijfte__sample_y@misc$min.nCount_RNA
                     #nFeature_RNA < 4500 & 
                     #nCount_RNA < 14000 &
                     #percent.mito < 0.025
)
```


# Normalize and cluster/UMAP
## Scale / normalize

```{r}
obj__van_hijfte__sample_y <- Seurat::NormalizeData(object = obj__van_hijfte__sample_y, normalization.method = "LogNormalize", scale.factor = 1e4)

obj__van_hijfte__sample_y <- Seurat::FindVariableFeatures(object = obj__van_hijfte__sample_y, selection.method = "vst", nfeatures = obj__van_hijfte__sample_y@misc$seurat.vst.nfeatures)



# Append known marker genes to the variable features
append <- intersect(setdiff(celltype_markers$markers, obj__van_hijfte__sample_y@assays$RNA@var.features), rownames(obj__van_hijfte__sample_y))
if(length(append) > 0) {
  message(paste0("Appending ", length(append), " marker genes to variable features"))
  obj__van_hijfte__sample_y@assays$RNA@var.features <- c(obj__van_hijfte__sample_y@assays$RNA@var.features, append)
}
rm(append)
```

## PCA

## Clustering

## UMAP

# Annotate clusters

# Store object

## Check git code changes and save

```{r}
# ensure all code was committed
assertthat::assert_that(length(system("git status --short", intern = TRUE)) == 0)

obj__van_hijfte__sample_y@misc$git_branch <- system("git branch --show-current", intern = TRUE)
obj__van_hijfte__sample_y@misc$git_revision <- system("git rev-parse --short HEAD", intern = TRUE)
saveRDS(obj__van_hijfte__sample_y,
       file=paste0("cache/",obj__van_hijfte__sample_y@misc$sample_name,"__",obj__van_hijfte__sample_y@misc$git_branch,".Rds"))
obj__van_hijfte__sample_y@misc$git_branch <- NULL
obj__van_hijfte__sample_y@misc$git_revision <- NULL

```


```{r}

library(dplyr)
library(Seurat)
library(patchwork)

# Load the PBMC dataset
pbmc.data <- Read10X(data.dir = "/tmp/filtered_gene_bc_matrices/hg19/")
# Initialize the Seurat object with the raw (non-normalized data).
pbmc <- CreateSeuratObject(counts = pbmc.data, project = "pbmc3k", min.cells = 3, min.features = 200)
pbmc


pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")

# Visualize QC metrics as a violin plot
VlnPlot(pbmc, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

plot1 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2


pbmc <- subset(pbmc, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)

pbmc <- NormalizeData(pbmc, normalization.method = "LogNormalize", scale.factor = 10000)

pbmc <- NormalizeData(pbmc)

pbmc <- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(pbmc), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(pbmc)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2





